#  04 | 依赖预构建
在这一章节中我们会讲到vite的一个重要功能——**依赖预构建**。当首次运行 Vite 的时候，Vite 会先执行依赖预构建。一般从入口文件(html)开始，通过esbuild递归分析出项目中所有的第三方依赖并打包成esm模块，打包后的文件放置在项目下的 **`/node_modules/.vite/deps`** 里，并且在 **`/node_modules/.vite/_metadata.json`** 中记录依赖打包后的信息，在开发环境下会将路径重写指向构建后的第三方依赖包地址。
<ZoomImg src="../../../../public/images/scan/scan02.jpg" />

## 预构建的原因
首先我们需要搞清楚vite为什么需要预构建，预构建能带来什么价值。官方文档中是这样描述的：
* **兼容 CommonJS 和 UMD 格式依赖库**

开发阶段，Vite 借助浏览器动态去加载esmodule模块能力，在开发服务器将所有代码视为原生 ES 模块，因此，必须先将作为 CommonJS 或 UMD 发布的依赖项转换为 ESM 模式才会能被浏览器加载。
* **打包第三方库将分散的资源合并**

Vite 将有许多内部模块的 ESM 依赖关系打包转换为单个模块，减少大量的请求阻塞浏览器。比如lodash-es 有超过 600 个内置模块，如果不做处理大量的请求会导致页面的加载速度相当慢。通过预构建 lodash-es 成为一个模块，只需要发送一个 HTTP 请。通过这种方式可以减少 HTTP 请求数量，提高后续页面的加载性能。

<ZoomImg src="../../../../public/images/scan/scan03.jpg" />

从上图可以看出：vite启动项目会打包 React 与 loadsh-es 示例，可以看出React被转换符合标准的esm模块，lodash-es内部的子依赖也打包成一个文件，并且项目中引用这些依赖的路径也被转换到了 `.vite/deps` 目录下。

> 🎯 注意：依赖预构建仅适用于开发模式，并使用 esbuild 将依赖项转换为 ES 模块。在生产构建中，将使用 @rollup/plugin-commonjs 插件直接打包

## 预构建的流程
项目启动时要对代码中引用资源进行预构建，首先要搞清这几个问题：
* 1、预构建的内容是什么？（哪些模块需要进行预构建）
* 2、如何找到需要预构建的模块？
* 3、找到的依赖模块如何构建？
* 4、构建好的模块需要怎么引用？（如何改写代码中模块的依赖地址）

接下来我们从这几个问题入手去看看vite是如何进行依赖预构建的。
  
